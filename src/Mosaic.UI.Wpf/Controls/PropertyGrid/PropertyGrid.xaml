<ResourceDictionary
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="clr-namespace:Mosaic.UI.Wpf.Controls"
    xmlns:themes="clr-namespace:Mosaic.UI.Wpf.Themes"
    xmlns:converters="clr-namespace:Mosaic.UI.Wpf.Converters"
    xmlns:system="clr-namespace:System;assembly=System.Runtime">

    <!-- Bool->Visibility converter for the editor button -->
    <BooleanToVisibilityConverter x:Key="BoolToVis" />

    <!--  Define a dedicated style for the PropertyGrid TextBox editor  -->
    <Style x:Key="PropertyGridTextBoxStyle" BasedOn="{StaticResource {x:Type TextBox}}" TargetType="TextBox">
        <Setter Property="VerticalAlignment" Value="Center" />
        <Setter Property="BorderThickness" Value="0" />
        <Setter Property="IsReadOnly" Value="{Binding IsReadOnly}" />
        <Setter Property="Padding" Value="4"></Setter>
        <Style.Triggers>
            <DataTrigger Binding="{Binding MaxLength}" Value="0">
                <!-- When no MaxLength is specified, use the maximum possible value -->
                <Setter Property="MaxLength" Value="2147483647" />
            </DataTrigger>
            <DataTrigger Binding="{Binding MaxLength, Converter={x:Static converters:GreaterThanZeroConverter.Instance}}" Value="True">
                <!-- When a specific MaxLength is provided, apply it -->
                <Setter Property="MaxLength" Value="{Binding MaxLength}" />
            </DataTrigger>
        </Style.Triggers>
    </Style>

    <!--  1.  The editor selector – picks the right template  -->
    <local:PropertyEditorSelector x:Key="PropertyEditorSelector" />

    <!--  2.  Editor templates  -->
    <DataTemplate x:Key="TextEditor">
        <TextBox
            Style="{StaticResource PropertyGridTextBoxStyle}"
            Text="{Binding Value, UpdateSourceTrigger=PropertyChanged, NotifyOnTargetUpdated=True, NotifyOnSourceUpdated=True, Mode=TwoWay}" />
    </DataTemplate>

    <DataTemplate x:Key="BoolEditor">
        <CheckBox
            Margin="2,2,0,2"
            VerticalAlignment="Center"
            IsEnabled="{Binding IsReadOnly, Converter={x:Static converters:InvertedBoolConverter.Instance}}"
            IsChecked="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, NotifyOnTargetUpdated=True, NotifyOnSourceUpdated=True}" />
    </DataTemplate>

    <DataTemplate x:Key="EnumEditor">
        <ComboBox
            VerticalAlignment="Center"
            BorderThickness="0"
            IsReadOnly="{Binding IsReadOnly}"
            ItemsSource="{Binding EnumValues}"
            SelectedItem="{Binding Value, UpdateSourceTrigger=PropertyChanged, NotifyOnTargetUpdated=True, NotifyOnSourceUpdated=True, Mode=TwoWay}" />
    </DataTemplate>

    <DataTemplate x:Key="NumberEditor">
        <local:NumericTextBox
            Padding="4"
            VerticalAlignment="Center"
            BorderThickness="0"
            DecimalPlaces="0"
            IsReadOnly="{Binding IsReadOnly}"
            Text="{Binding Value, UpdateSourceTrigger=PropertyChanged, NotifyOnTargetUpdated=True, NotifyOnSourceUpdated=True, Mode=TwoWay}" />
    </DataTemplate>

    <DataTemplate x:Key="DecimalEditor">
        <local:NumericTextBox
            Padding="4"
            VerticalAlignment="Center"
            BorderThickness="0"
            DecimalPlaces="10"
            IsReadOnly="{Binding IsReadOnly}"
            Text="{Binding Value, UpdateSourceTrigger=PropertyChanged, NotifyOnTargetUpdated=True, NotifyOnSourceUpdated=True, Mode=TwoWay}" />
    </DataTemplate>

    <DataTemplate x:Key="DateOnlyEditor">
        <DatePicker
            VerticalAlignment="Center"
            IsEnabled="{Binding IsReadOnly, Converter={x:Static converters:InvertedBoolConverter.Instance}}"
            Background="{DynamicResource {x:Static themes:MosaicTheme.ControlTextBackgroundBrush}}"
            BorderThickness="0"
            Foreground="{DynamicResource {x:Static themes:MosaicTheme.ControlTextForegroundBrush}}"
            SelectedDate="{Binding Value, UpdateSourceTrigger=LostFocus, NotifyOnTargetUpdated=True, NotifyOnSourceUpdated=True, Mode=TwoWay}" />
    </DataTemplate>

    <DataTemplate x:Key="StringListEditor">
        <ToggleButton
            x:Name="TogglePopupButton"
            Width="150"
            Height="30"
            HorizontalAlignment="Left"
            IsEnabled="{Binding IsReadOnly, Converter={x:Static converters:InvertedBoolConverter.Instance}}">
            <StackPanel>
                <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Run Text="Is button toggled? " />
                    <Run Text="{Binding IsChecked, ElementName=TogglePopupButton}" />
                </TextBlock>
                <Popup Name="myPopup" IsOpen="{Binding IsChecked, ElementName=TogglePopupButton}">
                    <Border BorderThickness="1">
                        <local:StringListEditor Items="{Binding Value}" />
                    </Border>
                </Popup>
            </StackPanel>
        </ToggleButton>
    </DataTemplate>

    <!--  3.  The PropertyGrid style  -->
    <Style TargetType="{x:Type local:PropertyGrid}">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type local:PropertyGrid}">
                    <Border
                        Background="{DynamicResource {x:Static themes:MosaicTheme.WindowBackgroundBrush}}"
                        BorderBrush="{DynamicResource {x:Static themes:MosaicTheme.ControlBorderBrush}}"
                        BorderThickness="1"
                        SnapsToDevicePixels="True"
                        UseLayoutRounding="True">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <!--  Search bar  -->
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!--  Search box (optional)  -->
                            <TextBox
                                x:Name="PART_Search"
                                Margin="4"
                                Visibility="Collapsed" />

                            <!--  The list of properties  -->
                            <ScrollViewer
                                Grid.Row="1"
                                Padding="0"
                                VerticalScrollBarVisibility="Auto">
                                <ItemsControl Margin="0" ItemsSource="{TemplateBinding Properties}">
                                    <!--  Group by Category  -->
                                    <ItemsControl.GroupStyle>
                                        <GroupStyle>
                                            <GroupStyle.HeaderTemplate>
                                                <DataTemplate>
                                                    <Border
                                                        Background="{DynamicResource {x:Static themes:MosaicTheme.ControlBackgroundLightBrush}}"
                                                        BorderBrush="{DynamicResource {x:Static themes:MosaicTheme.ControlBorderBrush}}"
                                                        BorderThickness="0,0,0,1">
                                                        <TextBlock
                                                            Padding="4"
                                                            FontWeight="Bold"
                                                            Foreground="{DynamicResource {x:Static themes:MosaicTheme.ControlForegroundBrush}}"
                                                            Text="{Binding Name}" />
                                                    </Border>
                                                </DataTemplate>
                                            </GroupStyle.HeaderTemplate>
                                            <GroupStyle.Panel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Margin="0" />
                                                </ItemsPanelTemplate>
                                            </GroupStyle.Panel>
                                        </GroupStyle>
                                    </ItemsControl.GroupStyle>

                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Margin="0" />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>

                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="200" />
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>

                                                <Border
                                                    HorizontalAlignment="Stretch"
                                                    VerticalAlignment="Stretch"
                                                    Background="{DynamicResource {x:Static themes:MosaicTheme.WindowBackgroundBrush}}"
                                                    BorderBrush="{DynamicResource {x:Static themes:MosaicTheme.ControlBorderBrush}}"
                                                    BorderThickness="0,0,1,1">
                                                    <TextBlock
                                                        Margin="6,0,0,0"
                                                        VerticalAlignment="Center"
                                                        Foreground="{DynamicResource {x:Static themes:MosaicTheme.ControlForegroundBrush}}"
                                                        Text="{Binding DisplayName}"
                                                        ToolTip="{Binding Description}" />
                                                </Border>

                                                <Border
                                                    Grid.Column="1"
                                                    BorderBrush="{DynamicResource {x:Static themes:MosaicTheme.ControlBorderBrush}}"
                                                    BorderThickness="0,0,0,1">
                                                    <ContentControl
                                                        Margin="0,0,0,0"
                                                        VerticalAlignment="Center"
                                                        Content="{Binding}"
                                                        ContentTemplateSelector="{StaticResource PropertyEditorSelector}" />
                                                </Border>

                                                <Button
                                                    Grid.Column="2"
                                                    Content="..."
                                                    Padding="4,0,4,0"
                                                    ToolTip="Open Editor"
                                                    Visibility="{Binding HasEditor, Converter={StaticResource BoolToVis}}"
                                                    Command="{Binding OpenEditorCommand}" />

                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
</ResourceDictionary>
